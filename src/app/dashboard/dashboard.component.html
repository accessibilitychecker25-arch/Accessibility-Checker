<app-file-upload 
  (submitted)="handleFile($event)" 
  (submittedMultiple)="handleFiles($event)"
  (cleared)="handleClear()"
  [hasResults]="!!remediation"
></app-file-upload>



<div class="card p-6 shadow-lg rounded-lg max-w-3xl mx-auto mt-6">
    <!-- debug banner removed -->
  <h2 class="text-2xl font-semibold text-center mb-6">
    Document Accessibility Remediation
  </h2>

  <div *ngIf="processedReports?.length" class="mb-4">
    <h4 class="text-md font-medium mb-2">Processed files</h4>
    <div class="grid grid-cols-1 gap-2">
      <div *ngFor="let p of processedReports; let idx = index" class="p-2 border rounded flex items-center justify-between">
        <div>
          <div class="font-medium">{{ p.response.report.fileName || p.response.fileName || 'Untitled' }}</div>
          <div class="text-sm text-gray-600">Fixed: {{ p.response.report.summary.fixed }} · Flagged: {{ p.response.report.summary.flagged }}</div>
        </div>
        <div class="space-x-2">
          <button class="text-sm px-2 py-1 bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 rounded" (click)="selectReport(idx)">View report</button>
          <button class="text-sm px-2 py-1 bg-blue-100 dark:bg-blue-700 dark:hover:bg-blue-600 text-gray-800 dark:text-gray-100 rounded" (click)="downloadReport(idx)">Download</button>
          <button class="text-sm px-2 py-1 bg-red-100 dark:bg-red-700 dark:hover:bg-red-600 text-red-800 dark:text-red-100 rounded" (click)="removeReport(idx)" title="Remove this report">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="isUploading" class="mt-3">
    <div>Uploading & processing… {{ progress }}%</div>
    <div class="relative pt-1">
      <div class="flex mb-2 items-center justify-between">
        <div
          class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-teal-600 bg-teal-200"
        >
          Progress
        </div>
      </div>
      <div class="flex mb-2">
        <div class="w-full bg-gray-200 rounded-full">
          <div
            class="bg-blue-500 text-xs font-medium text-blue-100 text-center p-0.5 leading-none rounded-l-full"
            [style.width.%]="progress"
          >
            {{ progress }}%
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-container *ngIf="remediation && !isUploading">
    <div class="mt-4">
      <h3 class="text-xl mb-4">
        Results for <strong>{{ remediation.report.fileName }}</strong>
      </h3>

      <div class="flex space-x-4 mb-4">
        <span class="text-green-500 font-medium">
          Fixed: {{ getFixedCount() }}
        </span>
        <span class="self-center text-sm text-gray-700 dark:text-gray-300">(client-estimated auto-fixes: {{ countAutoFixableIssues() }})</span>
        <span class="text-yellow-500 dark:text-yellow-400 font-medium">
          Flagged: {{ getFlaggedCount() }}
        </span>
      </div>

      <div *ngIf="remediation" class="mb-4">
        <h5 class="text-sm font-medium mb-2">Auto-fixed items (client estimate)</h5>
        <ul class="list-disc list-inside text-sm text-gray-700">
          <li *ngFor="let a of getAutoFixedItems()">{{ a }}</li>
          <li *ngIf="getAutoFixedItems().length === 0">(none detected)</li>
        </ul>
      </div>      <div *ngIf="remediation" class="mb-4">
        <button class="text-sm underline text-blue-600 dark:text-blue-300" (click)="showRawReport = !showRawReport">
          {{ showRawReport ? 'Hide' : 'Show' }} raw remediation report
        </button>

  <pre *ngIf="showRawReport" class="mt-2 p-3 bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-100 rounded text-xs overflow-auto whitespace-pre-wrap border border-gray-200 dark:border-gray-700">{{ rawReportJson }}</pre>
      </div>

      <button
        class="btn btn-primary mt-4 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600"
        (click)="downloadFixed()"
      >
        Download remediated .docx
      </button>

      <div
        *ngIf="remediation.suggestedFileName || downloadFileName"
        class="mt-2 text-sm text-gray-600"
      >
        Download filename: <code>{{ downloadFileName || remediation.suggestedFileName }}</code>
      </div>

      <!-- Post-download banner (shown when the original document was protected) -->
      <div *ngIf="showPostDownloadBanner" class="mt-4 p-4 border-l-4 border-yellow-400 bg-yellow-50 dark:bg-gray-800">
        <div class="flex items-start justify-between">
          <div class="mr-4">
            <strong>Note:</strong>
            <div class="text-sm">This file was protected when analyzed. If it still opens in Protected View after download, you can unblock it or use one of the alternatives below.</div>
          </div>
          <div class="flex-shrink-0 space-x-2">
            <button class="px-3 py-1 bg-gray-200 text-gray-800 dark:text-gray-100 rounded" (click)="showHelpModal = true">Show unblock steps</button>
            <a class="px-3 py-1 bg-indigo-600 text-white rounded" href="https://office.live.com/start/Word.aspx" target="_blank" rel="noopener">Open in Word Online</a>
            <a class="px-3 py-1 bg-green-600 text-white rounded" href="https://onedrive.live.com/" target="_blank" rel="noopener">Save to OneDrive</a>
            <button class="px-3 py-1 bg-gray-100 text-gray-800 dark:text-gray-100 rounded" (click)="showPostDownloadBanner = false">Dismiss</button>
          </div>
        </div>
      </div>

      <!-- Help modal shown when the user requests unblock steps -->
      <app-help-modal
        *ngIf="showHelpModal"
        [fileName]="(downloadFileName || remediation.suggestedFileName || remediation.report.fileName) || ''"
        (close)="showHelpModal = false"
      ></app-help-modal>

      <hr class="my-6" />

      <h4 class="text-lg mb-2">Details</h4>
      <ul *ngIf="issues.length; else noIssues">
        <li *ngFor="let i of issues" class="mb-4">
          <div
            [class]="i.type === 'fixed' ? 'text-green-500' : i.type === 'flagged' ? 'text-yellow-500 dark:text-yellow-400' : ''"
          >
            <span class="mr-2">•</span>
            <span [innerHTML]="i.message"></span>
          </div>
        </li>
      </ul>
      <ng-template #noIssues
        ><p class="text-gray-600">No issues to report.</p></ng-template
      >
    </div>
  </ng-container>

  <div *ngIf="!remediation && !isUploading" class="mt-3 text-muted">
    Upload a .docx to get started.
  </div>
</div>
